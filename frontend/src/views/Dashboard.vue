<template>
  <div class="dashboard">

    <!-- IEEE PHM 2012 å¯¦é©—æ‘˜è¦ -->
    <el-row :gutter="20" style="margin-top: 20px;">
      <el-col :span="24">
        <el-card>
          <template #header>
            <div class="card-header">
              <span>ğŸ”¬ IEEE PHM 2012 æ•¸æ“šæŒ‘æˆ°å¯¦é©—æ‘˜è¦</span>
              <el-tag type="info">Remaining Useful Life é æ¸¬</el-tag>
            </div>
          </template>
          
          <el-row :gutter="20">
            <el-col :span="8">
              <el-card shadow="never" class="summary-card">
                <template #header>
                  <div class="summary-header">
                    <el-icon><Aim /></el-icon>
                    <span>å¯¦é©—ç›®çš„</span>
                  </div>
                </template>
                <div class="summary-content">
                  <p><strong>è»¸æ‰¿å‰©é¤˜ä½¿ç”¨å£½å‘½ï¼ˆRULï¼‰é æ¸¬</strong></p>
                  <p>å°ˆæ³¨æ–¼æ—‹è½‰æ©Ÿæ¢°ä¸­è»¸æ‰¿æ•…éšœçš„é æ¸¬ï¼Œæé«˜å·¥æ¥­æ©Ÿæ¢°çš„å¯ç”¨æ€§ã€å®‰å…¨æ€§å’Œæˆæœ¬æ•ˆç›Šã€‚</p>
                  <el-divider />
                  <p><strong>å¤±æ•ˆæ¨™æº–ï¼š</strong>æŒ¯å‹•å¹…åº¦è¶…é 20g</p>
                  <p><strong>å¹³å°ï¼š</strong>PRONOSTIA å¯¦é©—å¹³å°</p>
                  <p><strong>åœ°é»ï¼š</strong>FEMTO-ST ç ”ç©¶æ‰€ï¼ˆæ³•åœ‹ï¼‰</p>
                </div>
              </el-card>
            </el-col>

            <el-col :span="8">
              <el-card shadow="never" class="summary-card">
                <template #header>
                  <div class="summary-header">
                    <el-icon><Tools /></el-icon>
                    <span>æ¸¬è©¦æ–¹å¼</span>
                  </div>
                </template>
                <div class="summary-content">
                  <p><strong>è»¸æ‰¿è¦æ ¼ï¼š</strong></p>
                  <ul>
                    <li>å¤–å¾‘ï¼š32mmï¼Œå…§å¾‘ï¼š20mmï¼Œåšåº¦ï¼š7mm</li>
                    <li>13 å€‹æ»¾ç ï¼Œç›´å¾‘ 3.5mm</li>
                    <li>å‹•æ…‹è² è¼‰ï¼š4000Nï¼Œéœæ…‹è² è¼‰ï¼š2470N</li>
                  </ul>
                  <el-divider />
                  <p><strong>ä¸‰ç¨®æ“ä½œæ¢ä»¶ï¼š</strong></p>
                  <el-tag size="small">1800 rpm, 4000 N</el-tag>
                  <el-tag size="small" style="margin: 2px;">1650 rpm, 4200 N</el-tag>
                  <el-tag size="small">1500 rpm, 5000 N</el-tag>
                </div>
              </el-card>
            </el-col>

            <el-col :span="8">
              <el-card shadow="never" class="summary-card">
                <template #header>
                  <div class="summary-header">
                    <el-icon><Folder /></el-icon>
                    <span>è³‡æ–™é›†</span>
                  </div>
                </template>
                <div class="summary-content">
                  <p><strong>è¨“ç·´è³‡æ–™ï¼š</strong>6 å€‹å®Œæ•´çš„é‹è¡Œè‡³å¤±æ•ˆå¯¦é©—</p>
                  <p><strong>æ¸¬è©¦è³‡æ–™ï¼š</strong>11 å€‹æˆªæ–·çš„ç›£æ¸¬è³‡æ–™</p>
                  <el-divider />
                  <p><strong>æ•¸æ“šæ¡é›†ï¼š</strong></p>
                  <ul>
                    <li>æŒ¯å‹•ï¼š25.6 kHz æ¡æ¨£é »ç‡</li>
                    <li>æº«åº¦ï¼š0.1 Hz æ¡æ¨£é »ç‡</li>
                    <li>å…©å€‹åŠ é€Ÿåº¦è¨ˆï¼ˆæ°´å¹³/å‚ç›´ï¼‰</li>
                    <li>RTD ç™½é‡‘æº«åº¦æ„Ÿæ¸¬å™¨</li>
                  </ul>
                  <p><strong>å¯¦é©—æ™‚é•·ï¼š</strong>1å°æ™‚ - 7å°æ™‚47åˆ†</p>
                </div>
              </el-card>
            </el-col>
          </el-row>

          <el-row style="margin-top: 15px;">
            <el-col :span="24">
              <el-card shadow="never" class="summary-card">
                <template #header>
                  <div class="summary-header">
                    <el-icon><TrendCharts /></el-icon>
                    <span>æŒ‘æˆ°ç‰¹è‰²èˆ‡æŠ€è¡“é‡é»</span>
                  </div>
                </template>
                <div class="summary-content">
                  <el-row :gutter="15">
                    <el-col :span="6">
                      <div class="challenge-item">
                        <el-tag type="warning" size="small">å°è¨“ç·´é›†</el-tag>
                        <p>åƒ…6å€‹é‹è¡Œè‡³å¤±æ•ˆå¯¦é©—</p>
                      </div>
                    </el-col>
                    <el-col :span="6">
                      <div class="challenge-item">
                        <el-tag type="danger" size="small">é«˜è®Šç•°æ€§</el-tag>
                        <p>è»¸æ‰¿å£½å‘½å·®ç•°æ¥µå¤§</p>
                      </div>
                    </el-col>
                    <el-col :span="6">
                      <div class="challenge-item">
                        <el-tag type="info" size="small">å¤šå¤±æ•ˆæ¨¡å¼</el-tag>
                        <p>æ»¾ç ã€å…§/å¤–ç’°ã€ä¿æŒæ¶</p>
                      </div>
                    </el-col>
                    <el-col :span="6">
                      <div class="challenge-item">
                        <el-tag type="success" size="small">çœŸå¯¦åŠ£åŒ–</el-tag>
                        <p>è‡ªç„¶åŠ£åŒ–ç„¡äººå·¥ç¼ºé™·</p>
                      </div>
                    </el-col>
                  </el-row>
                  <el-divider />
                  <div class="scoring-info">
                    <strong>è©•åˆ†æ–¹æ³•ï¼š</strong>éå°ç¨±è©•åˆ†å‡½æ•¸ï¼Œå°æ—©æœŸå’Œæ™šæœŸé æ¸¬æ¡ç”¨ä¸åŒæ‡²ç½°æ©Ÿåˆ¶
                    <br><strong>ç²çè€…ï¼š</strong>å·¥æ¥­çµ„ - A.L.D. Ltd. (ä»¥è‰²åˆ—)ï¼Œå­¸è¡“çµ„ - CALCE, University of Maryland
                  </div>
                </div>
              </el-card>
            </el-col>
          </el-row>
        </el-card>
      </el-col>
    </el-row>

    <!-- æ™‚åŸŸç‰¹å¾µåˆ†ææ¨¡çµ„ -->
    <el-row :gutter="20" style="margin-top: 20px;">
      <el-col :span="24">
        <el-card>
          <template #header>
            <h2>æ™‚åŸŸç‰¹å¾µåˆ†æ</h2>
          </template>

          <h3>åŸç†èªªæ˜</h3>
          <p>æ™‚åŸŸç‰¹å¾µç›´æ¥å¾åŸå§‹æŒ¯å‹•ä¿¡è™Ÿä¸­æå–çµ±è¨ˆç‰¹å¾µï¼Œç”¨æ–¼æ•´é«”å¥åº·è©•ä¼°ã€‚</p>

          <h4>ä¸»è¦ç‰¹å¾µ:</h4>
          <el-descriptions :column="1" border>
            <el-descriptions-item label="Peakï¼ˆå³°å€¼ï¼‰">
              <code>Peak = max(|signal|)</code>
              <p>åæ˜ æœ€å¤§æŒ¯å‹•å¹…åº¦ï¼Œç”¨æ–¼æª¢æ¸¬è¡æ“Š</p>
            </el-descriptions-item>
            <el-descriptions-item label="RMSï¼ˆå‡æ–¹æ ¹å€¼ï¼‰">
              <code>RMS = sqrt(mean(signalÂ²))</code>
              <p>åæ˜ æ•´é«”æŒ¯å‹•èƒ½é‡ï¼Œæœ€å¸¸ç”¨çš„å¥åº·æŒ‡æ¨™</p>
            </el-descriptions-item>
            <el-descriptions-item label="Kurtosisï¼ˆå³°åº¦ï¼‰">
              <code>Kurt = E[(X-Î¼)â´] / Ïƒâ´</code>
              <p>åæ˜ ä¿¡è™Ÿå°–éŠ³ç¨‹åº¦ï¼Œç•°å¸¸å‡é«˜è¡¨ç¤ºè¡æ“Š</p>
            </el-descriptions-item>
            <el-descriptions-item label="Crest Factorï¼ˆæ³¢å³°å› æ•¸ï¼‰">
              <code>CF = Peak / RMS</code>
              <p>åæ˜ å³°å€¼èˆ‡å¹³å‡å€¼çš„æ¯”å€¼</p>
            </el-descriptions-item>
          </el-descriptions>

          <h4 style="margin-top: 20px;">æ‡‰ç”¨å ´æ™¯:</h4>
          <el-tag type="success" style="margin: 5px;">ç£¨æç¨‹åº¦ç›£æ¸¬</el-tag>
          <el-tag type="warning" style="margin: 5px;">ç•°å¸¸æª¢æ¸¬</el-tag>

          <el-alert
            title="è¨ºæ–·æº–å‰‡"
            type="info"
            style="margin-top: 15px;"
            :closable="false"
          >
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li>RMS ç·©æ…¢ä¸Šå‡ â†’ ç£¨æåŠ åŠ‡</li>
              <li>Kurtosis > 8 â†’ åš´é‡è¡æ“Šï¼Œå¯èƒ½å­˜åœ¨ç¼ºé™·</li>
            </ul>
          </el-alert>

          <!-- å³æ™‚è¨ˆç®—å€åŸŸ -->
          <el-divider>å³æ™‚è¨ˆç®—æ¼”ç¤º</el-divider>

          <el-row :gutter="20">
            <el-col :span="12">
              <el-form label-width="120px">
                <el-form-item label="é¸æ“‡è»¸æ‰¿">
                  <el-select v-model="timeDomainParams.bearingName" placeholder="è«‹é¸æ“‡è»¸æ‰¿">
                    <el-option label="Bearing1_1" value="Bearing1_1" />
                    <el-option label="Bearing1_2" value="Bearing1_2" />
                    <el-option label="Bearing2_1" value="Bearing2_1" />
                    <el-option label="Bearing2_2" value="Bearing2_2" />
                    <el-option label="Bearing3_1" value="Bearing3_1" />
                    <el-option label="Bearing3_2" value="Bearing3_2" />
                  </el-select>
                </el-form-item>
                <el-form-item label="æª”æ¡ˆç·¨è™Ÿ">
                  <el-input-number v-model="timeDomainParams.fileNumber" :min="1" :max="100" />
                </el-form-item>
                <el-form-item>
                  <el-button type="primary" @click="calculateTimeDomain" :loading="timeDomainLoading">
                    è¨ˆç®—æ™‚åŸŸç‰¹å¾µ
                  </el-button>
                  <el-button @click="calculateTimeDomainTrend" :loading="trendLoading">
                    è¨ˆç®—è¶¨å‹¢åˆ†æ
                  </el-button>
                </el-form-item>
              </el-form>
            </el-col>
            <el-col :span="12" v-if="timeDomainResult">
              <el-card shadow="hover">
                <template #header>
                  <h4>è¨ˆç®—çµæœ</h4>
                </template>
                <el-descriptions :column="2" border size="small">
                  <el-descriptions-item label="è³‡æ–™é»æ•¸">
                    {{ timeDomainResult.data_points }}
                  </el-descriptions-item>
                  <el-descriptions-item label="è»¸æ‰¿åç¨±">
                    {{ timeDomainResult.bearing_name }}
                  </el-descriptions-item>
                  <el-descriptions-item label="æ°´å¹³ Peak">
                    {{ timeDomainResult.horizontal.peak.toFixed(4) }}
                  </el-descriptions-item>
                  <el-descriptions-item label="å‚ç›´ Peak">
                    {{ timeDomainResult.vertical.peak.toFixed(4) }}
                  </el-descriptions-item>
                  <el-descriptions-item label="æ°´å¹³ RMS">
                    {{ timeDomainResult.horizontal.rms.toFixed(4) }}
                  </el-descriptions-item>
                  <el-descriptions-item label="å‚ç›´ RMS">
                    {{ timeDomainResult.vertical.rms.toFixed(4) }}
                  </el-descriptions-item>
                  <el-descriptions-item label="æ°´å¹³ Crest Factor">
                    {{ timeDomainResult.horizontal.crest_factor.toFixed(4) }}
                  </el-descriptions-item>
                  <el-descriptions-item label="å‚ç›´ Crest Factor">
                    {{ timeDomainResult.vertical.crest_factor.toFixed(4) }}
                  </el-descriptions-item>
                  <el-descriptions-item label="æ°´å¹³å³°åº¦">
                    {{ timeDomainResult.horizontal.kurtosis.toFixed(4) }}
                  </el-descriptions-item>
                  <el-descriptions-item label="å‚ç›´å³°åº¦">
                    {{ timeDomainResult.vertical.kurtosis.toFixed(4) }}
                  </el-descriptions-item>
                </el-descriptions>
              </el-card>
            </el-col>
          </el-row>

          <!-- æŒ¯å‹•ä¿¡è™Ÿåœ–è¡¨ -->
          <div v-if="timeDomainResult" style="margin-top: 20px;">
            <el-card>
              <template #header>
                <h4>æŒ¯å‹•ä¿¡è™Ÿæ³¢å½¢</h4>
              </template>
              <div ref="timeDomainSignalChart" style="width: 100%; height: 400px;"></div>
            </el-card>
          </div>

          <!-- è¶¨å‹¢åˆ†æåœ–è¡¨ -->
          <div v-if="trendResult" style="margin-top: 20px;">
            <el-card>
              <template #header>
                <h4>æ™‚åŸŸç‰¹å¾µè¶¨å‹¢åˆ†æï¼ˆå…± {{ trendResult.file_count }} å€‹æª”æ¡ˆï¼‰</h4>
              </template>
              <div ref="timeDomainTrendChart" style="width: 100%; height: 400px;"></div>
            </el-card>
          </div>
        </el-card>
      </el-col>
    </el-row>

  </div>
</template>

<script setup>
import { ref, nextTick } from 'vue'
import * as echarts from 'echarts'
import { Aim, Tools, Folder, TrendCharts } from '@element-plus/icons-vue'

// æ™‚åŸŸè¨ˆç®—åƒæ•¸
const timeDomainParams = ref({
  bearingName: 'Bearing1_1',
  fileNumber: 1
})

const timeDomainLoading = ref(false)
const trendLoading = ref(false)
const timeDomainResult = ref(null)
const trendResult = ref(null)

// Chart refs
const timeDomainSignalChart = ref(null)
const timeDomainTrendChart = ref(null)

// è¨ˆç®—æ™‚åŸŸç‰¹å¾µ
const calculateTimeDomain = async () => {
  timeDomainLoading.value = true
  try {
    const response = await fetch(
      `http://localhost:8081/api/algorithms/time-domain/${timeDomainParams.value.bearingName}/${timeDomainParams.value.fileNumber}`
    )
    if (!response.ok) throw new Error('è¨ˆç®—å¤±æ•—')

    timeDomainResult.value = await response.json()

    // ç¹ªè£½ä¿¡è™Ÿæ³¢å½¢åœ–
    await nextTick()
    drawSignalChart()
  } catch (error) {
    console.error('è¨ˆç®—æ™‚åŸŸç‰¹å¾µå¤±æ•—:', error)
    alert('è¨ˆç®—å¤±æ•—: ' + error.message)
  } finally {
    timeDomainLoading.value = false
  }
}

// è¨ˆç®—è¶¨å‹¢åˆ†æ
const calculateTimeDomainTrend = async () => {
  trendLoading.value = true
  try {
    const response = await fetch(
      `http://localhost:8081/api/algorithms/time-domain-trend/${timeDomainParams.value.bearingName}?max_files=50`
    )
    if (!response.ok) throw new Error('è¨ˆç®—å¤±æ•—')

    trendResult.value = await response.json()

    // ç¹ªè£½è¶¨å‹¢åœ–
    await nextTick()
    drawTrendChart()
  } catch (error) {
    console.error('è¨ˆç®—è¶¨å‹¢åˆ†æå¤±æ•—:', error)
    alert('è¨ˆç®—å¤±æ•—: ' + error.message)
  } finally {
    trendLoading.value = false
  }
}

// ç¹ªè£½ä¿¡è™Ÿæ³¢å½¢åœ–
const drawSignalChart = () => {
  if (!timeDomainSignalChart.value || !timeDomainResult.value) return

  const chart = echarts.init(timeDomainSignalChart.value)

  const option = {
    title: {
      text: 'æŒ¯å‹•åŠ é€Ÿåº¦ä¿¡è™Ÿ'
    },
    tooltip: {
      trigger: 'axis'
    },
    legend: {
      data: ['æ°´å¹³æ–¹å‘', 'å‚ç›´æ–¹å‘'],
      top: '5%',
      right: '5%'
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '3%',
      containLabel: true
    },
    xAxis: {
      type: 'category',
      data: timeDomainResult.value.signal_data.time,
      name: 'æ¨£æœ¬é»'
    },
    yAxis: {
      type: 'value',
      name: 'åŠ é€Ÿåº¦ (g)'
    },
    series: [
      {
        name: 'æ°´å¹³æ–¹å‘',
        type: 'line',
        data: timeDomainResult.value.signal_data.horizontal,
        showSymbol: false,
        lineStyle: { width: 1 }
      },
      {
        name: 'å‚ç›´æ–¹å‘',
        type: 'line',
        data: timeDomainResult.value.signal_data.vertical,
        showSymbol: false,
        lineStyle: { width: 1 }
      }
    ]
  }

  chart.setOption(option)
}

// ç¹ªè£½è¶¨å‹¢åœ–
const drawTrendChart = () => {
  if (!timeDomainTrendChart.value || !trendResult.value) return

  const chart = echarts.init(timeDomainTrendChart.value)

  const option = {
    title: {
      text: 'æ™‚åŸŸç‰¹å¾µè¶¨å‹¢'
    },
    tooltip: {
      trigger: 'axis'
    },
    legend: {
      data: ['æ°´å¹³ RMS', 'å‚ç›´ RMS', 'æ°´å¹³å³°åº¦', 'å‚ç›´å³°åº¦'],
      top: '1%',
      right: '5%'
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '3%',
      containLabel: true
    },
    xAxis: {
      type: 'category',
      data: trendResult.value.file_numbers,
      name: 'æª”æ¡ˆç·¨è™Ÿ'
    },
    yAxis: [
      {
        type: 'value',
        name: 'RMS',
        position: 'left'
      },
      {
        type: 'value',
        name: 'å³°åº¦',
        position: 'right'
      }
    ],
    series: [
      {
        name: 'æ°´å¹³ RMS',
        type: 'line',
        yAxisIndex: 0,
        data: trendResult.value.horizontal.rms,
        smooth: true
      },
      {
        name: 'å‚ç›´ RMS',
        type: 'line',
        yAxisIndex: 0,
        data: trendResult.value.vertical.rms,
        smooth: true
      },
      {
        name: 'æ°´å¹³å³°åº¦',
        type: 'line',
        yAxisIndex: 1,
        data: trendResult.value.horizontal.kurtosis,
        smooth: true
      },
      {
        name: 'å‚ç›´å³°åº¦',
        type: 'line',
        yAxisIndex: 1,
        data: trendResult.value.vertical.kurtosis,
        smooth: true
      }
    ]
  }

  chart.setOption(option)
}
</script>

<style scoped>
.dashboard {
  padding: 20px;
}

.header-stats {
  margin-bottom: 20px;
}

.stat-card {
  display: flex;
  align-items: center;
}

.stat-card :deep(.el-card__body) {
  display: flex;
  align-items: center;
  padding: 20px;
}

.stat-icon {
  width: 60px;
  height: 60px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  margin-right: 15px;
}

.stat-info h3 {
  font-size: 28px;
  font-weight: bold;
  margin: 0 0 5px;
  color: #303133;
}

.stat-info p {
  font-size: 14px;
  color: #909399;
  margin: 0;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* IEEE PHM 2012 å¯¦é©—æ‘˜è¦æ¨£å¼ */
.summary-card {
  height: 100%;
  border: 1px solid #f0f0f0;
  border-radius: 8px;
}

.summary-card :deep(.el-card__header) {
  background-color: #fafafa;
  border-bottom: 1px solid #f0f0f0;
  padding: 12px 16px;
}

.summary-header {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  color: #303133;
}

.summary-content {
  padding: 16px;
  font-size: 13px;
  line-height: 1.5;
}

.summary-content p {
  margin-bottom: 8px;
  color: #606266;
}

.summary-content ul {
  margin: 8px 0;
  padding-left: 20px;
}

.summary-content li {
  margin-bottom: 4px;
  color: #606266;
}

.summary-content strong {
  color: #303133;
}

.challenge-item {
  text-align: center;
  padding: 12px 8px;
  border-radius: 6px;
  background-color: #fafafa;
  height: 100%;
}

.challenge-item p {
  margin-top: 8px;
  font-size: 12px;
  color: #606266;
  line-height: 1.4;
}

.scoring-info {
  background-color: #f8f9fa;
  padding: 12px;
  border-radius: 6px;
  font-size: 12px;
  color: #606266;
  line-height: 1.5;
}
</style>
