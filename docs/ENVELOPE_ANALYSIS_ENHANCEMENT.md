# 包絡分析功能增強摘要

## 更新日期
2025年（根據系統日期2025-10-28）

## 增強內容

### 1. 振幅指標說明 (Amplitude Indicators)
在包絡分析區段新增了詳細的振幅指標說明，包括：

- **包絡RMS (Envelope RMS)**
  - 公式: `ERMS = √(1/N * ΣA²(t))`
  - 用途: 反映整體振動能量

- **包絡峰值 (Envelope Peak)**
  - 公式: `Peak = max(A(t))`
  - 用途: 檢測衝擊強度

- **總功率 (Total Power)**
  - 公式: `Power = ΣMagnitude²(f)`
  - 用途: 包絡頻譜的總能量

- **信噪比 (SNR)**
  - 公式: `SNR = Peak_Signal / Noise_Level`
  - 用途: > 3 表示缺陷顯著

### 2. IEEE PHM 2012 軸承故障頻率計算 (SKF 6205)
新增完整的軸承故障頻率計算表，基於文檔 13.1.2 節：

| 軸承名稱 | 轉速(RPM) | 軸頻率(Hz) | BPFO(Hz) | BPFI(Hz) | BSF(Hz) | FTF(Hz) |
|----------|-----------|------------|----------|----------|---------|---------|
| Bearing1_1 | 1800 | 30.0 | **95.59** | 144.41 | 70.70 | 11.95 |
| Bearing1_2 | 1650 | 27.5 | **87.63** | 132.37 | 64.81 | 10.95 |
| Bearing2_1 | 1650 | 27.5 | **87.63** | 132.37 | 64.81 | 10.95 |
| Bearing2_2 | 1800 | 30.0 | **95.59** | 144.41 | 70.70 | 11.95 |
| Bearing3_1 | 1500 | 25.0 | **79.66** | 120.34 | 58.92 | 9.96 |
| Bearing3_2 | 1650 | 27.5 | **87.63** | 132.37 | 64.81 | 10.95 |

### 3. 診斷嚴重程度標準
基於文檔 13.4 節的量化標準：

| 嚴重程度 | 包絡RMS | 信噪比 | 諧波數量 | 維護建議 |
|----------|---------|--------|----------|----------|
| 正常 | < 0.03 | < 2.0 | 0-1 | 正常監測 |
| 輕微異常 | 0.03-0.06 | 2.0-3.0 | 1-2 | 加強監測 |
| 中度故障 | 0.06-0.10 | 3.0-5.0 | 2-3 | 計畫維護 |
| 嚴重故障 | > 0.10 | > 5.0 | > 3 | **立即維護** |

### 4. 增強的結果顯示
計算結果區域新增：
- 峰值頻率和對應幅值的詳細顯示
- 濾波頻帶參數顯示
- **故障頻率自動識別功能**

### 5. 故障頻率自動檢測功能
實現了智能故障頻率檢測系統 (基於文檔 13.3 節)：

#### 檢測特徵
- **BPFO (外圈故障頻率)**: 檢測基頻及前5個諧波
- **BPFI (內圈故障頻率)**: 檢測基頻及前5個諧波
- **BSF (滾動體自轉頻率)**: 檢測基頻及諧波
- **頻率容差**: ±5% (符合文檔 13.5 節建議)

#### 嚴重程度判定
- 1個諧波: 信息級別 (info)
- 2個諧波: 警告級別 (warning)
- 3個以上諧波: 錯誤級別 (error) - 表示嚴重故障

### 6. 包絡頻譜圖增強

#### 包絡頻譜圖 (主圖)
- 清晰顯示實際測量的包絡頻譜數據
- 不含故障頻率標記線，避免視覺干擾
- 支援內部縮放功能 (滑鼠滾輪) ✅
- 支援滑桿縮放，預設顯示前50%頻率範圍 ✅
- 使用連續數值X軸，提高頻率精度
- 顯示軸承名稱、轉速及軸頻率

#### 故障頻率參考圖 (獨立圖表)
獨立的故障頻率參考圖表，用於對照診斷：

- **BPFO (外圈故障頻率)**: 紅色實線（基頻）+ 紅色虛線（諧波）
  - 顯示基頻及2x、3x諧波
- **BPFI (內圈故障頻率)**: 橙色實線（基頻）+ 橙色虛線（諧波）
  - 顯示基頻及2x、3x諧波
- **BSF (滾動體自轉頻率)**: 藍色實線（基頻）+ 藍色虛線（諧波）
  - 顯示基頻及2x諧波
- **FTF (保持架頻率)**: 綠色實線（基頻）+ 綠色虛線（諧波）
  - 顯示基頻及2x諧波

優點：
- 故障頻率與實際頻譜分離，方便對照觀察
- 避免BPFO、BPFI等高頻值影響主頻譜圖的顯示範圍
- 每條標記線顯示頻率數值，便於精確識別
- 提供清晰的診斷參考基準

## 技術實現

### 前端代碼結構
```javascript
// 數據定義
const bearingFaultFrequencies = [...] // IEEE PHM 2012 故障頻率表
const severityLevels = [...]           // 診斷嚴重程度標準
const detectedFaults = ref([])         // 檢測到的故障

// Chart refs
const envelopeChart = ref(null)              // 包絡頻譜圖
const faultFreqReferenceChart = ref(null)    // 故障頻率參考圖

// 核心函數
detectFaultFrequencies()        // 故障頻率檢測
findHarmonics()                 // 諧波搜尋
drawEnvelopeChart()             // 繪製包絡頻譜圖（不含標記線）
drawFaultFreqReferenceChart()   // 繪製故障頻率參考圖（獨立圖表）
```

### 故障檢測算法
```javascript
// 1. 獲取峰值頻率列表
const allPeakFreqs = [
  ...horizontal.peak_frequencies,
  ...vertical.peak_frequencies
]

// 2. 對每種故障類型檢測諧波
for (let harmonic = 1; harmonic <= 5; harmonic++) {
  const expectedFreq = targetFreq * harmonic
  // 在容差範圍內尋找匹配
  const match = peakFreqs.find(f =>
    Math.abs(f - expectedFreq) / expectedFreq <= 0.05
  )
}

// 3. 根據諧波數量判定嚴重程度
```

## 使用方式

1. **選擇軸承**: 從下拉選單選擇要分析的軸承 (Bearing1_1 ~ Bearing3_2)
2. **設置參數**:
   - 檔案編號: 1-100
   - 低通頻率: 建議 4000 Hz
   - 高通頻率: 建議 10000 Hz
3. **執行計算**: 點擊「計算包絡頻譜」按鈕
4. **查看結果**:
   - 振幅特徵 (Envelope RMS, 峰值頻率等)
   - 故障頻率識別結果 (自動檢測)
   - 包絡頻譜圖 (含故障頻率標記)

## 診斷示例

### 正常狀態 (Bearing1_1)
```
包絡RMS: 0.025
主要峰值頻率: [30.0, 60.0] Hz (軸頻率諧波)
信噪比: 1.8
診斷: 正常狀態 - 無明顯故障特徵頻率
```

### 早期故障 (Bearing1_2)
```
包絡RMS: 0.045 (↑80%)
檢測到頻率: 87.63 Hz (BPFO)
信噪比: 2.9
診斷: 疑似外圈早期故障 - 建議加強監測
```

### 嚴重故障 (Bearing3_1)
```
包絡RMS: 0.120 (↑380%)
檢測到頻率: 79.66, 159.32, 239.0 Hz (BPFO及諧波)
信噪比: 6.2
診斷: 嚴重故障 - 立即維護建議
```

## 參考文檔
- `docs/qwen_envelope_analysis.md` - 完整的包絡分析技術文件
  - 第5節: 振幅指標
  - 第13節: 故障特徵頻率計算與實際應用
  - 第13.1.2節: IEEE PHM 2012 軸承計算結果
  - 第13.3節: 故障類型識別指南
  - 第13.4節: 診斷準則量化標準

## 文件修改
- `frontend/src/views/Algorithms.vue`
  - 新增振幅指標說明區段
  - 新增IEEE PHM 2012故障頻率表
  - 新增診斷嚴重程度表
  - 增強結果顯示卡片
  - 實現故障頻率自動檢測
  - **重構包絡頻譜圖顯示方式**：
    - 主頻譜圖：移除故障頻率標記線，僅顯示實際數據
    - 新增獨立的故障頻率參考圖 (`faultFreqReferenceChart`)
    - 新增 `drawFaultFreqReferenceChart()` 函數
    - 支援滑鼠滾輪縮放 (dataZoom type: 'inside') ✅
    - 支援滑桿縮放 (dataZoom type: 'slider') ✅

## 後續優化建議

1. **後端API增強**: 考慮在後端直接計算故障頻率檢測，返回診斷結果
2. **信噪比計算**: 在後端添加真實的SNR計算
3. **趨勢分析**: 增加包絡分析的趨勢圖功能
4. **報告生成**: 自動生成包絡分析診斷報告
5. **多軸承對比**: 同時顯示多個軸承的包絡頻譜對比

## 注意事項

1. **頻率容差**: 允許±5%誤差，符合實際工程應用
2. **諧波判定**: 需要至少檢測到基頻才會觸發故障警報
3. **多故障識別**: 可能同時檢測到多種故障頻率 (BPFO + BPFI)
4. **數據質量**: 檢測準確度依賴於包絡頻譜的信噪比和頻率解析度
