# 時頻分析 (Time-Frequency Analysis) 技術文件

## 目錄
1. [原理說明](#原理說明)
2. [關鍵概念](#關鍵概念)
3. [處理流程](#處理流程)
4. [主要特徵](#主要特徵)
5. [故障頻率的基準](#故障頻率的基準)
6. [診斷準則](#診斷準則)
7. [應用場景](#應用場景)
8. [窗函數選項](#窗函數選項)
9. [圖表說明](#圖表說明)

## 原理說明

時頻分析是一種同時在時間和頻率域上分析信號的技術，主要用於檢測非穩態信號、瞬態事件和頻率隨時間變化的現象。與傳統的傅立葉轉換只能提供頻率域信息不同，時頻分析能夠揭示信號在時間-頻率平面的特徵，對於機械故障診斷特別有用。

在振動信號分析中，時頻分析常用於：
- 檢測瞬態衝擊事件
- 分析非穩態運轉狀態
- 識別隨時間變化的頻率成分
- 定位故障事件的時間點

## 關鍵概念

### STFT (Short-Time Fourier Transform) - 短時傅立葉轉換
- 原理：將信號分割成短段，對每段進行傅立葉轉換
- 特點：提供時間-頻率的二維表示
- 時頻解析度：時間窗大小決定解析度平衡（海森堡不確定性原理）

### CWT (Continuous Wavelet Transform) - 連續小波轉換
- 原理：使用不同尺度的小波基函數與信號做卷積
- 特點：多解析度分析，在高頻有好的時間解析度，在低頻有好的頻率解析度
- 小波基：常用的有 Morlet 小波、Ricker 小波等

### 時頻能量分布 (Time-Frequency Energy Distribution)
- 概念：表示信號能量在時間-頻率平面的分布
- 應用：識別瞬態事件發生的時間和頻率位置

### 瞬時頻率 (Instantaneous Frequency)
- 定義：信號相位對時間的導數
- 應用：分析非穩態信號的瞬時頻率變化

## 處理流程

### STFT 處理流程
```python
1. 輸入原始振動信號 x(t)
2. 選擇窗函數 (Hann, Flattop, Hamming)
3. 設定參數：nperseg (每段長度), noverlap (重疊長度)
4. 滑動窗函數對信號分段，對每段做 FFT
5. 組合各段結果得 STFT 結果 S(f, t)
6. 計算幅度 |S(f, t)|, 功率 |S(f, t)|² 等特徵
7. 提取 NP4、峰值頻率、總能量等指標
```

### CWT 處理流程
```python
1. 輸入原始振動信號 x(t)
2. 選擇小波基函數 (Morlet, Ricker)
3. 設定尺度範圍 (通常為 1-64)
4. 對每個尺度計算小波係數
5. 得到 CWT 結果 W(a, t)，其中 a 為尺度參數
6. 計算幅度 |W(a, t)|, 每尺度能量等特徵
7. 提取 NP4、峰值尺度、總能量等指標
```

### 譜圖 (Spectrogram) 處理流程
```python
1. 使用 scipy.signal.spectrogram 函數
2. 設定窗函數和參數
3. 計算功率譜密度
4. 轉換為 dB 單位
5. 提取統計特徵 (平均功率、最大功率、峰值時間頻率等)
```

## 主要特徵

### NP4 (Normalized Power of 4th Order Moment) 特徵
- 定義：`NP4 = N·Σ(Z-μ)⁴ / [Σ(Z-μ)²]²`
- 物理意義：類似峰度，反映時頻能量分佈的集中程度
- 應用：檢測瞬態衝擊、局部缺陷
- 閾值：> 3 表示存在顯著的瞬態事件

### 時頻能量指標
- 總能量：`Σ|STFT|²` 或 `Σ|CWT|²`
- 峰值頻率/尺度：能量最大的頻率或尺度值
- 峰值時間：最大能量發生的時間點
- 平均功率：時頻平面的平均功率值

### 瞬時特徵
- 瞬時相位：`φ(t) = arctan(H[x(t)] / x(t))`
- 瞬時頻率：`f(t) = (1/2π) · dφ/dt`
- 包絡線：`A(t) = |z(t)| = √(x²(t) + H[x(t)]²)`

## 故障頻率的基準

在軸承診斷中，時頻分析可用於檢測以下故障頻率：

### 故障類型及特徵頻率
- **BPFO (Ball Pass Frequency Outer race)** - 滾子通過外圈故障頻率
- **BPFI (Ball Pass Frequency Inner race)** - 滾子通過內圈故障頻率
- **BSF (Ball Spin Frequency)** - 滾子自轉頻率
- **FTF (Fundamental Train Frequency)** - 保持架頻率

### IEEE PHM 2012 軸承 (SKF 6205) 參考頻率
在 2000 RPM 轉速下：
- 軸頻率：33.33 Hz
- BPFO：104.4 Hz
- BPFI：147.3 Hz
- BSF：24.2 Hz
- FTF：3.9 Hz

## 診斷準則

### STFT 診斷準則
- NP4 > 3 → 存在瞬態衝擊或局部缺陷
- 頻率能量集中 → 某頻段異常
- 時間能量集中 → 某時段異常事件

### CWT 診斷準則
- 尺度能量異常 → 特定頻段能量變化
- NP4 > 3 → 瞬態事件檢測
- 多尺度能量分佈 → 故障頻率分佈特徵

### 包絡分析診斷準則
- 包絡譜出現 BPFO/BPFI → 滾動體或軌道缺陷
- 信噪比 > 3 → 缺陷顯著
- 多個諧波 (2×BPFO, 3×BPFO...) → 缺陷嚴重
- 包絡 RMS 上升 → 振動能量增加
- NB4 > 3 → 包絡線存在顯著峰值（可能有衝擊）

### 綜合診斷邏輯
1. **早期故障**：NP4 異常，能量分佈開始變化
2. **中期故障**：頻率成分增多，諧波出現
3. **嚴重故障**：能量大幅增加，多個故障頻率重疊

## 應用場景

### 瞬態衝擊檢測
- **適用對象**：軸承、齒輪箱、軸承座等機械部件
- **檢測對象**：裂紋、剝落、異物進入等
- **特點**：瞬態事件在時間域表現為短時間高能量事件

### 異物進入檢測
- **適用對象**：軸承系統、液壓系統
- **檢測對象**：金屬顆粒、雜質等
- **特點**：異物撞擊產生的瞬態信號

### 早期微裂紋檢測
- **適用對象**：轉子、軸承、齒輪
- **檢測對象**：表面裂紋、疲勞裂紋
- **特點**：早期裂紋產生的低幅度瞬態信號

### 非穩態運轉分析
- **適用對象**：啟停機、負載變化
- **檢測對象**：共振頻率變化、運轉狀態變化
- **特點**：頻率隨時間變化的分析

### 調幅信號分析
- **適用對象**：齒輪箱、軸承
- **檢測對象**：載波頻率及其邊帶
- **特點**：調製現象的時頻域表現

## 窗函數選項

### Hann 窗
- **特點**：主瓣寬度適中，旁瓣抑制良好
- **應用**：一般頻譜分析，平衡時間和頻率解析度
- **參數**：長度通常為 128 或 256 點
- **優缺點**：解析度平衡，適合多數應用

### Flattop 窗
- **特點**：極好的幅度精度，平坦的頻率響應
- **應用**：精確的幅度測量，校準應用
- **參數**：長度通常為 256 點
- **優缺點**：幅度測量精度高，但頻率解析度較差

### Hamming 窗
- **特點**：良好的旁瓣抑制，主瓣較窄
- **應用**：一般頻譜分析，類似 Hann 窗
- **參數**：長度通常為 128 或 256 點
- **優缺點**：與 Hann 窗性能相似，但旁瓣特性略有不同

### 窗函數選擇指南
- **時間解析度優先**：選擇較短窗長
- **頻率解析度優先**：選擇較長窗長
- **幅度精度優先**：選擇 Flattop 窗
- **一般應用**：選擇 Hann 窗

## 圖表說明

### STFT 頻譜圖（時頻能量分布）

**含義**：
- **X軸**：時間軸，顯示信號的時間變化過程
- **Y軸**：頻率軸，顯示信號的頻率成分
- **Z軸（顏色）**：能量或幅度值，顏色越亮表示該時間-頻率點的能量越大

**解讀方法**：
1. **水平直線**：表示某個恒定頻率成分
2. **垂直直線**：表示瞬態事件在所有頻率上的響應
3. **傾斜線**：表示頻率隨時間變化的現象（如掃頻）
4. **能量集中點**：表示瞬態衝擊或特定頻率事件

**診斷應用**：
- 瞬態衝擊：在時頻圖上表現為短時間的高能量點
- 頻率漂移：表現為頻率隨時間變化
- 周期性事件：表現為周期性的能量變化

### CWT 小波係數圖

**含義**：
- **X軸**：時間軸，顯示信號的時間變化過程
- **Y軸**：尺度軸或頻率軸，尺度越大對應的頻率越低
- **Z軸（顏色）**：小波係數的幅度值

**解讀方法**：
1. **高頻區域（小尺度）**：對應信號的高頻成分
2. **低頻區域（大尺度）**：對應信號的低頻成分
3. **係數集中**：表示該時間-尺度下的信號結構

**診斷應用**：
- 故障特徵識別：不同尺度下的係數分佈反映不同頻率範圍的故障特徵
- 多解析度分析：同時獲得高頻和低頻的時間定位

### 各尺度能量分布

**含義**：
- **X軸**：尺度或對應頻率
- **Y軸**：該尺度下的總能量
- **曲線**：顯示能量在不同尺度（頻率）下的分佈

**解讀方法**：
1. **能量峰值**：表示該尺度（頻率）下的主要成分
2. **能量分佈形狀**：反映信號的頻率特性
3. **多峰結構**：表示多個頻率成分的存在

**診斷應用**：
- 頻率成分識別：通過能量峰值識別主要頻率成分
- 故障頻率定位：查找故障特徵頻率對應的尺度

### 頻譜圖（時頻功率分布）

**含義**：
- **X軸**：時間軸
- **Y軸**：頻率軸
- **Z軸（顏色）**：功率值（通常以 dB 為單位）

**解讀方法**：
1. **功率密度**：顏色深淺表示功率大小
2. **功率變化**：顏色隨時間的變化反映功率的時間演變
3. **頻率結構**：沿頻率軸的變化反映頻率成分

**診斷應用**：
- 功率異常檢測：功率突然增大或減小表示異常
- 頻率漂移監測：頻率成分的時間變化
- 能量分佈變化：整體能量分佈的演變

## 參數設置與優化

### STFT 參數優化
- **nperseg**：影響時間-頻率解析度權衡，通常取 128-512 點
- **noverlap**：影響時間解析度，通常設定為 90-95%
- **window**：根據應用需求選擇合適窗函數

### CWT 參數優化
- **wavelet**：Morlet 適合連續信號，Ricker 適合瞬態信號
- **scales**：覆蓋感興趣的頻率範圍，通常為 1-64
- **freq_range**：設定分析的頻率範圍

### 計算效率考慮
- 對於實時應用：選擇較小的參數和快速算法
- 對於精度要求高：增加參數精度和計算點數
- 記憶體優化：分段處理長時間序列

## 高級應用

### 標準化能量分析 (NE)
- **原理**：對時頻平面進行分段分析，計算各時頻區域的標準化能量
- **應用**：故障模式識別，能量分佈特徵提取
- **頻率範圍**：通常設定為 800-2500 Hz 的感興趣頻段

### 雙窗口分析
- **原理**：同時使用不同參數的窗口進行分析，比較結果
- **應用**：驗證分析結果的可靠性，提高診斷準確性

## 注意事項

1. **解析度權衡**：時間解析度和頻率解析度存在固有權衡
2. **邊界效應**：在信號邊界可能存在分析誤差
3. **計算複雜度**：時頻分析通常計算量較大
4. **參數選擇**：參數選擇對結果影響顯著，需根據應用優化
5. **噪聲影響**：時頻分析對噪聲敏感，可能需要預處理

## 總結

時頻分析提供了時域和頻域之外的第三維度視角，對於機械故障診斷特別重要。通過 STFT、CWT 等方法，可以同時獲得信號在時間和頻率上的特徵，對瞬態事件、非穩態信號和調製信號具有獨特的分析能力。正確的參數選擇和結果解讀是實現有效診斷的關鍵。